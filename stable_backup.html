<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Financial Projection</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Favicon: Green cash emoji -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='50%' x='50%' text-anchor='middle' dominant-baseline='central' font-size='48'%3E%F0%9F%92%B5%3C/text%3E%3C/svg%3E">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .event-link {
            text-decoration: underline;
            cursor: pointer;
            color: #4C51BF; /* Tailwind indigo-700 */
        }
        
        /* Custom Tooltip Styles for the Expenses, Taxes and Savings columns */
        .has-tooltip {
            position: relative;
        }

        .tooltip-text {
            visibility: hidden;
            opacity: 0;
            background-color: #1f2937;
            color: #ffffff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Position the tooltip above the container */
            left: 50%;
            transform: translateX(-50%);
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .has-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }
        /* Custom styles for the top-right icons */
        .button-tooltip-container {
            position: relative;
            display: inline-block;
        }
        .button-tooltip-text {
            visibility: hidden;
            opacity: 0;
            background-color: #1f2937;
            color: #ffffff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 10;
            top: 125%; 
            left: 50%;
            transform: translateX(-50%);
            transition: opacity 0.3s ease-in-out;
            white-space: nowrap;
        }
        .button-tooltip-container:hover .button-tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Dark Mode Specific Styles */
        .dark-mode {
            background-color: #1a202c; /* Tailwind gray-900 */
            color: #e2e8f0; /* Tailwind gray-200 */
        }
        .dark-mode .app-screen {
            background-color: #1a202c;
        }
        .dark-mode .bg-white, .dark-mode .modal-overlay .bg-white {
            background-color: #2d3748; /* Tailwind gray-800 */
            color: #e2e8f0;
        }
        .dark-mode .text-gray-800 { color: #f7fafc; }
        .dark-mode .text-gray-600 { color: #a0aec0; }
        .dark-mode .text-gray-700 { color: #cbd5e0; }
        .dark-mode input, .dark-mode select {
            background-color: #4a5568; /* Tailwind gray-700 */
            border-color: #4a5568;
            color: #e2e8f0;
        }
        .dark-mode .border-gray-300 { border-color: #4a5568; }
        .dark-mode .text-gray-500 { color: #a0aec0; }
        .dark-mode .bg-gray-50 { background-color: #2d3748; }
        .dark-mode .divide-gray-200 { border-color: #4a5568; }
        .dark-mode .bg-gray-100 { background-color: #1a202c; }
        .dark-mode .bg-gray-50 { background-color: #2d3748; }
        .dark-mode .hover\:bg-gray-50:hover { background-color: #4a5568; }
        .dark-mode .bg-red-100 { background-color: #4c1111; }
        .dark-mode .text-gray-900 { color: #f7fafc; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <!-- Main Application Container -->
    <div id="app-container" class="min-h-screen">
        <!-- Initial Input Screen -->
        <div id="initial-screen" class="app-screen min-h-screen flex items-center justify-center p-4">
             <div class="absolute top-4 right-4 z-50">
                 <button id="initial-screen-dark-mode-toggle" class="bg-gray-200 dark:bg-gray-700 p-2 rounded-full shadow-md transition-colors duration-200 ease-in-out">
                    <i class="fas fa-moon text-gray-800 dark:text-yellow-400"></i>
                </button>
            </div>
            <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-xl">
                <h1 class="text-3xl font-bold text-center mb-4 text-gray-800">Your Financial Snapshot</h1>
                <p class="text-center text-gray-600 mb-8">Enter your current financial details to get started. Assumptions will use default values which you can edit later.</p>
                <form id="initial-form" class="space-y-6">
                    <div>
                        <label for="netWorth" class="block text-sm font-medium text-gray-700">Current Net Worth ($)</label>
                        <input type="number" id="netWorth" name="netWorth" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                    </div>
                    <div>
                        <label for="income" class="block text-sm font-medium text-gray-700">Current Annual Income ($)</label>
                        <input type="number" id="income" name="income" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                    </div>
                    <div>
                        <label for="expenses" class="block text-sm font-medium text-gray-700">Current Annual Expenses ($)</label>
                        <input type="number" id="expenses" name="expenses" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                    </div>
                    <div>
                        <label for="taxFilingStatus" class="block text-sm font-medium text-gray-700">Tax Filing Status</label>
                        <select id="taxFilingStatus" name="taxFilingStatus" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                            <option value="single">Single</option>
                            <option value="married">Married Filing Jointly</option>
                            <option value="headOfHousehold">Head of Household</option>
                            <option value="custom">Custom Rate</option>
                        </select>
                    </div>
                    <div id="customTaxRateContainer" class="hidden">
                        <label for="customTaxRate" class="block text-sm font-medium text-gray-700">Custom Annual Tax Rate (%)</label>
                        <input type="number" id="customTaxRate" name="customTaxRate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                    </div>
                    <div>
                        <label for="currentAge" class="block text-sm font-medium text-gray-700">Current Age</label>
                        <input type="number" id="currentAge" name="currentAge" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        Start Projection
                    </button>
                </form>
            </div>
        </div>

        <!-- Main Dashboard Screen -->
        <div id="main-dashboard" class="app-screen hidden p-4 sm:p-8">
            <div class="flex flex-col md:flex-row md:space-x-8">
                <!-- Main Content Area -->
                <div class="flex-1 space-y-8">
                    <div class="flex justify-between items-center mb-4">
                         <h1 class="text-3xl font-bold text-gray-800">Financial Dashboard</h1>
                        <div class="flex space-x-2">
                             <!-- Edit Initial Data Button with Tooltip -->
                             <div class="relative button-tooltip-container">
                                <button id="edit-initial-data-btn"
                                    class="text-sm md:text-md text-white bg-green-500 hover:bg-green-600 px-3 py-2 rounded-full shadow focus:outline-none focus:ring-1 focus:ring-green-400 transition duration-150 ease-in-out opacity-70 hover:opacity-100">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <span class="button-tooltip-text">Edit Initial Data</span>
                            </div>
                             <!-- Edit Assumptions Button with Tooltip -->
                             <div class="relative button-tooltip-container">
                                <button id="edit-assumptions-btn"
                                    class="text-sm md:text-md text-white bg-blue-500 hover:bg-blue-600 px-3 py-2 rounded-full shadow focus:outline-none focus:ring-1 focus:ring-blue-400 transition duration-150 ease-in-out opacity-70 hover:opacity-100">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                                <span class="button-tooltip-text">Edit Assumptions</span>
                            </div>
                            <!-- Restart Session Button with Tooltip -->
                            <div class="relative button-tooltip-container">
                                <button id="restart-session-btn"
                                    class="text-sm md:text-md text-white bg-red-500 hover:bg-red-600 px-3 py-2 rounded-full shadow focus:outline-none focus:ring-1 focus:ring-red-400 transition duration-150 ease-in-out opacity-70 hover:opacity-100">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <span class="button-tooltip-text">Restart Session</span>
                            </div>
                            <!-- Dark Mode Toggle Button -->
                            <div class="relative button-tooltip-container">
                                <button id="dashboard-dark-mode-toggle"
                                    class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-yellow-400 text-sm md:text-md px-3 py-2 rounded-full shadow focus:outline-none focus:ring-1 focus:ring-yellow-300 transition-colors duration-200 ease-in-out opacity-70 hover:opacity-100">
                                    <i class="fas fa-sun light-icon"></i>
                                    <i class="fas fa-moon dark-icon hidden"></i>
                                </button>
                                <span class="button-tooltip-text">Toggle Dark Mode</span>
                            </div>
                        </div>
                    </div>
                    <!-- Key Metrics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white rounded-2xl p-6 shadow-md flex flex-col justify-between">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-semibold text-gray-600">Current Net Worth</h3>
                                <button id="edit-current-net-worth-btn" class="text-sm text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>
                            <div class="flex items-center">
                                <span id="current-net-worth" class="text-3xl font-bold text-gray-900 mr-2"></span>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl p-6 shadow-md flex flex-col justify-between">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-semibold text-gray-600">Projected Net Worth at Retirement</h3>
                                <button id="edit-retirement-assumptions-btn" class="text-sm text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>
                            <p id="projected-net-worth" class="text-4xl font-bold text-indigo-600 mt-2"></p>
                            <p id="retirement-message" class="text-sm mt-2 font-medium"></p>
                        </div>
                        <div class="bg-white rounded-2xl p-6 shadow-md flex flex-col justify-between">
                            <h3 class="text-xl font-semibold text-gray-600">Yearly Savings Target</h3>
                            <p id="savings-target" class="text-4xl font-bold text-emerald-600 mt-2"></p>
                        </div>
                        <!-- New Net Worth Required to Retire Card -->
                        <div class="bg-white rounded-2xl p-6 shadow-md flex flex-col justify-between">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-semibold text-gray-600">Net Worth Required to Retire</h3>
                                <button id="edit-fi-assumptions-btn" class="text-sm text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>
                            <p id="fi-number-display" class="text-4xl font-bold text-gray-900 mt-2"></p>
                            <p class="text-sm mt-2 text-gray-500">Based on your annual expenses and safe withdrawal rate.</p>
                        </div>
                        <div class="bg-white rounded-2xl p-6 shadow-md flex flex-col justify-between">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-semibold text-gray-600">Age of Financial Independence</h3>
                                <button id="edit-fi-age-assumptions-btn" class="text-sm text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>
                            <p id="fi-age" class="text-4xl font-bold text-teal-600 mt-2"></p>
                            <p id="fi-message" class="text-sm text-gray-500"></p>
                        </div>
                        <div id="zero-age-card" class="bg-white rounded-2xl p-6 shadow-md flex flex-col justify-between">
                             <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-semibold text-gray-600">Net Worth Hits $0</h3>
                                 <button id="edit-lifespan-assumptions-btn" class="text-sm text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>
                            <p id="zero-age" class="text-4xl font-bold text-rose-600 mt-2"></p>
                            <p class="text-sm text-gray-500" id="zero-age-message"></p>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="bg-white rounded-2xl p-6 shadow-md mt-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Projection Charts</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">Net Worth Over Time</h3>
                                <div class="chart-container">
                                    <canvas id="netWorthChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">Yearly Financials</h3>
                                <div class="chart-container">
                                    <canvas id="yearlyFinancialsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Life Events Section -->
                    <div class="bg-white rounded-2xl p-6 shadow-md mt-8">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-800">Life Events</h2>
                            <button id="add-life-event-btn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-600 transition">
                                Add Event
                            </button>
                        </div>
                        <ul id="life-events-list" class="space-y-4">
                            <!-- Life events will be rendered here -->
                        </ul>
                    </div>

                    <!-- Projection Table Section -->
                    <div class="bg-white rounded-2xl p-6 shadow-md mt-8 overflow-x-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-800">Detailed Projection</h2>
                            <!-- Table header for projection details -->
                        </div>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Income</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Taxes</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expenses</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Savings</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Events</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Net Worth</th>
                                    <th scope="col" class="relative px-6 py-3"><span class="sr-only">Edit</span></th>
                                </tr>
                            </thead>
                            <tbody id="projection-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Table rows will be rendered dynamically by renderProjectionTable() -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Life Event Modal -->
    <div id="life-event-modal" class="modal-overlay hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 id="life-event-title" class="text-2xl font-bold text-gray-800">Add New Life Event</h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <form id="life-event-form" class="space-y-4">
                <div>
                    <label for="event-name" class="block text-sm font-medium text-gray-700">Event Name</label>
                    <input type="text" id="event-name" name="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="event-startAge" class="block text-sm font-medium text-gray-700">Age</label>
                    <input type="number" id="event-startAge" name="startAge" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                 <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-semibold text-gray-700 mb-2">Financial Change</h4>
                    <div>
                        <select id="event-change-type" name="changeType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="">Select...</option>
                            <option value="income">Income</option>
                            <option value="expenses">Expenses</option>
                            <option value="taxRate">Tax Rate</option>
                            <option value="oneTimeExpense">One-time Expense</option>
                        </select>
                    </div>

                    <div id="change-inputs-container" class="mt-4 hidden space-y-2">
                        <!-- Conditional inputs will be rendered here -->
                        <div id="income-change-fields" class="change-field hidden space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Income Change</label>
                            <div class="flex items-center space-x-2">
                                <select id="income-op" name="income-op" class="mt-1 block rounded-md border-gray-300 shadow-sm">
                                    <option value="set">Set to</option>
                                    <option value="change">Change by</option>
                                </select>
                                <input type="number" id="income-value" name="income-value" placeholder="Value" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <select id="income-type" name="income-type" class="mt-1 block rounded-md border-gray-300 shadow-sm">
                                    <option value="amount">$</option>
                                    <option value="percent">%</option>
                                </select>
                            </div>
                        </div>

                        <div id="expenses-change-fields" class="change-field hidden space-y-2">
                             <label class="block text-sm font-medium text-gray-700">Expenses Change</label>
                            <div class="flex items-center space-x-2">
                                <select id="expenses-op" name="expenses-op" class="mt-1 block rounded-md border-gray-300 shadow-sm">
                                    <option value="set">Set to</option>
                                    <option value="change">Change by</option>
                                </select>
                                <input type="number" id="expenses-value" name="expenses-value" placeholder="Value" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <select id="expenses-type" name="expenses-type" class="mt-1 block rounded-md border-gray-300 shadow-sm">
                                    <option value="amount">$</option>
                                    <option value="percent">%</option>
                                </select>
                            </div>
                        </div>

                        <div id="taxRate-change-fields" class="change-field hidden space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Tax Rate Change</label>
                            <div class="flex items-center space-x-2">
                                <select id="taxRate-op" name="taxRate-op" class="mt-1 block rounded-md border-gray-300 shadow-sm">
                                    <option value="set">Set to</option>
                                    <option value="change">Change by</option>
                                </select>
                                <input type="number" id="taxRate-value" name="taxRate-value" placeholder="Value" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <span class="text-sm font-medium text-gray-700">%</span>
                            </div>
                        </div>
                        
                        <div id="oneTimeExpense-change-fields" class="change-field hidden space-y-2">
                            <label class="block text-sm font-medium text-gray-700">One-time Expense Amount ($)</label>
                            <input type="number" id="oneTimeExpense-value" name="oneTimeExpense-value" placeholder="e.g. 25000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                    </div>
                </div>
                <div>
                    <label for="event-duration" class="block text-sm font-medium text-gray-700">Duration (Years)</label>
                    <input type="number" id="event-duration" name="duration" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="e.g. 5 or -1 for until death">
                </div>
                <div class="flex justify-end pt-4">
                    <button type="submit" id="life-event-submit-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">
                        Add Event
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Assumptions Modal -->
    <div id="assumptions-modal" class="modal-overlay hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800">Edit Assumptions</h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <form id="assumptions-form" class="space-y-6">
                 <div>
                    <label for="annualIncomeIncrease" class="block text-sm font-medium text-gray-700">Annual Income Increase (%)</label>
                    <input type="number" id="annualIncomeIncrease" name="annualIncomeIncrease" required step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="investmentReturnRate" class="block text-sm font-medium text-gray-700">Annual Investment Return Rate (%)</label>
                    <input type="number" id="investmentReturnRate" name="investmentReturnRate" required step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="inflationRate" class="block text-sm font-medium text-gray-700">Annual Inflation Rate (%)</label>
                    <input type="number" id="inflationRate" name="inflationRate" required step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="safeWithdrawalRate" class="block text-sm font-medium text-gray-700">Safe Withdrawal Rate (%)</label>
                    <input type="number" id="safeWithdrawalRate" name="safeWithdrawalRate" required step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="retirementAge" class="block text-sm font-medium text-gray-700">Target Retirement Age</label>
                    <input type="number" id="retirementAge" name="retirementAge" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="retirementExpenses" class="block text-sm font-medium text-gray-700">Annual Expenses in Retirement ($)</label>
                    <input type="number" id="retirementExpenses" name="retirementExpenses" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="retirementIncome" class="block text-sm font-medium text-gray-700">Annual Income in Retirement ($)</label>
                    <input type="number" id="retirementIncome" name="retirementIncome" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="lifeExpectancy" class="block text-sm font-medium text-gray-700">Life Expectancy</label>
                    <input type="number" id="lifeExpectancy" name="lifeExpectancy" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Save Assumptions
                </button>
            </form>
        </div>
    </div>

    <!-- Edit Retirement Assumptions Modal -->
    <div id="retirement-assumptions-modal" class="modal-overlay hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800">Edit Retirement Assumptions</h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <form id="retirement-assumptions-form" class="space-y-6">
                <div>
                    <label for="retirementSafeWithdrawalRate" class="block text-sm font-medium text-gray-700">Safe Withdrawal Rate (%)</label>
                    <input type="number" id="retirementSafeWithdrawalRate" name="safeWithdrawalRate" required step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="retirementRetirementAge" class="block text-sm font-medium text-gray-700">Target Retirement Age</label>
                    <input type="number" id="retirementRetirementAge" name="retirementAge" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="retirementRetirementExpenses" class="block text-sm font-medium text-gray-700">Annual Expenses in Retirement ($)</label>
                    <input type="number" id="retirementRetirementExpenses" name="retirementExpenses" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="retirementRetirementIncome" class="block text-sm font-medium text-gray-700">Annual Income in Retirement ($)</label>
                    <input type="number" id="retirementRetirementIncome" name="retirementIncome" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="retirementLifeExpectancy" class="block text-sm font-medium text-gray-700">Life Expectancy</label>
                    <input type="number" id="retirementLifeExpectancy" name="lifeExpectancy" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Save Changes
                </button>
            </form>
        </div>
    </div>
    
    <!-- Edit Initial Data Modal -->
    <div id="initial-data-modal" class="modal-overlay hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800">Edit Initial Data</h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <form id="initial-data-form" class="space-y-6">
                <div>
                    <label for="editNetWorth" class="block text-sm font-medium text-gray-700">Current Net Worth ($)</label>
                    <input type="number" id="editNetWorth" name="netWorth" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="editIncome" class="block text-sm font-medium text-gray-700">Current Annual Income ($)</label>
                    <input type="number" id="editIncome" name="income" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="editExpenses" class="block text-sm font-medium text-gray-700">Current Annual Expenses ($)</label>
                    <input type="number" id="editExpenses" name="expenses" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="editTaxFilingStatus" class="block text-sm font-medium text-gray-700">Tax Filing Status</label>
                    <select id="editTaxFilingStatus" name="taxFilingStatus" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                        <option value="single">Single</option>
                        <option value="married">Married Filing Jointly</option>
                        <option value="headOfHousehold">Head of Household</option>
                        <option value="custom">Custom Rate</option>
                    </select>
                </div>
                <div id="editCustomTaxRateContainer" class="hidden">
                    <label for="editCustomTaxRate" class="block text-sm font-medium text-gray-700">Custom Annual Tax Rate (%)</label>
                    <input type="number" id="editCustomTaxRate" name="customTaxRate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="editCurrentAge" class="block text-sm font-medium text-gray-700">Current Age</label>
                    <input type="number" id="editCurrentAge" name="currentAge" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition duration-150 ease-in-out">
                </div>
                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Save Changes
                </button>
            </form>
        </div>
    </div>


    <!-- JavaScript -->
    <script>
        // --- DEFAULTS & STATE ---
        const TAX_BRACKETS = {
            single: [
                { rate: 0.10, min: 0, max: 11925 },
                { rate: 0.12, min: 11926, max: 48475 },
                { rate: 0.22, min: 48476, max: 103350 },
                { rate: 0.24, min: 103351, max: 197300 },
                { rate: 0.32, min: 197301, max: 250525 },
                { rate: 0.35, min: 250526, max: 626350 },
                { rate: 0.37, min: 626351, max: Infinity }
            ],
            married: [
                { rate: 0.10, min: 0, max: 23850 },
                { rate: 0.12, min: 23851, max: 96950 },
                { rate: 0.22, min: 96951, max: 206700 },
                { rate: 0.24, min: 206701, max: 394600 },
                { rate: 0.32, min: 394601, max: 501050 },
                { rate: 0.35, min: 501051, max: 751600 },
                { rate: 0.37, min: 751601, max: Infinity }
            ],
            headOfHousehold: [
                { rate: 0.10, min: 0, max: 17000 },
                { rate: 0.12, min: 17001, max: 64850 },
                { rate: 0.22, min: 64851, max: 103350 },
                { rate: 0.24, min: 103351, max: 197300 },
                { rate: 0.32, min: 197301, max: 250500 },
                { rate: 0.35, min: 250501, max: 626350 },
                { rate: 0.37, min: 626351, max: Infinity }
            ]
        };

        const DEFAULTS = {
            netWorth: 22000,
            income: 85000,
            expenses: 42500,
            taxFilingStatus: 'single',
            customTaxRate: 20,
            currentAge: 33,
            annualIncomeIncrease: 2,
            investmentReturnRate: 8,
            inflationRate: 3,
            safeWithdrawalRate: 4,
            retirementAge: 65,
            retirementExpenses: 50000,
            retirementIncome: 0,
            lifeExpectancy: 90
        };

        const state = {
            initialData: { ...DEFAULTS },
            lifeEvents: [],
            isSetup: false,
            projection: [],
            fiAge: null,
            zeroAge: null
        };
        
        // Dark Mode Logic
        const darkModeState = {
            enabled: false,
            key: 'darkModeEnabled'
        };

        const applyDarkMode = (enabled) => {
            if (enabled) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            // Update chart colors
            if (netWorthChart) updateChartColors();
            // Update the icon
            const lightIcon = document.querySelector('.light-icon');
            const darkIcon = document.querySelector('.dark-icon');
            if (lightIcon && darkIcon) {
                if (enabled) {
                    lightIcon.classList.add('hidden');
                    darkIcon.classList.remove('hidden');
                } else {
                    lightIcon.classList.remove('hidden');
                    darkIcon.classList.add('hidden');
                }
            }
        };

        const toggleDarkMode = () => {
            darkModeState.enabled = !darkModeState.enabled;
            localStorage.setItem(darkModeState.key, darkModeState.enabled);
            applyDarkMode(darkModeState.enabled);
        };
        
        const loadDarkMode = () => {
            const savedState = localStorage.getItem(darkModeState.key);
            darkModeState.enabled = savedState === 'true';
            applyDarkMode(darkModeState.enabled);
        };
        
        const updateChartColors = () => {
            if (netWorthChart) {
                const darkColor = '#667eea'; // Tailwind indigo-400
                const lightColor = '#4299E1'; // Tailwind blue-500
                const gridColor = '#4a5568';
                const textColor = '#cbd5e0';
                
                netWorthChart.data.datasets[0].borderColor = darkModeState.enabled ? darkColor : lightColor;
                netWorthChart.data.datasets[0].backgroundColor = darkModeState.enabled ? 'rgba(102, 126, 234, 0.2)' : 'rgba(66, 153, 225, 0.2)';
                netWorthChart.options.scales.y.grid.color = darkModeState.enabled ? gridColor : '#E2E8F0';
                netWorthChart.options.scales.x.grid.color = darkModeState.enabled ? gridColor : '#E2E8F0';
                netWorthChart.options.scales.y.ticks.color = darkModeState.enabled ? textColor : '#6B7280';
                netWorthChart.options.scales.x.ticks.color = darkModeState.enabled ? textColor : '#6B7280';
                netWorthChart.update();
            }

            if (yearlyFinancialsChart) {
                yearlyFinancialsChart.options.scales.y.grid.color = darkModeState.enabled ? '#4a5568' : '#E2E8F0';
                yearlyFinancialsChart.options.scales.x.grid.color = darkModeState.enabled ? '#4a5568' : '#E2E8F0';
                yearlyFinancialsChart.options.scales.y.ticks.color = darkModeState.enabled ? '#cbd5e0' : '#6B7280';
                yearlyFinancialsChart.options.scales.x.ticks.color = darkModeState.enabled ? '#cbd5e0' : '#6B7280';
                yearlyFinancialsChart.update();
            }
        };

        // --- UTILITY FUNCTIONS ---
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(amount);
        }

        function formatAge(age) {
            if (age === null || age === undefined) return 'N/A';
            return age;
        }

        const saveDataToLocalStorage = () => {
            localStorage.setItem('financialProjectionState', JSON.stringify(state));
            updateUI();
        };

        const loadDataFromLocalStorage = () => {
            try {
                const savedState = localStorage.getItem('financialProjectionState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    Object.assign(state, parsedState);
                    // Handle new properties if old state is loaded
                    state.initialData.retirementIncome = parsedState.initialData.retirementIncome || DEFAULTS.retirementIncome;
                }
            } catch (error) {
                console.error("Failed to load state from localStorage:", error);
            }
        };
        
        // --- TAX CALCULATION LOGIC ---
        const calculateTax = (income, filingStatus) => {
            if (filingStatus === 'custom') {
                return income * (state.initialData.customTaxRate / 100);
            }

            const brackets = TAX_BRACKETS[filingStatus];
            if (!brackets) return 0;

            let totalTax = 0;
            let remainingIncome = income;

            for (const bracket of brackets) {
                if (remainingIncome <= 0) break;
                
                const taxableAmountInBracket = Math.min(remainingIncome, bracket.max - bracket.min + 1);
                totalTax += taxableAmountInBracket * bracket.rate;
                remainingIncome -= taxableAmountInBracket;
            }

            return totalTax;
        };


        // --- PROJECTION LOGIC ---
        const calculateProjection = () => {
            const projection = [];
            let { netWorth, income, expenses, customTaxRate, taxFilingStatus, currentAge, annualIncomeIncrease, investmentReturnRate, inflationRate, safeWithdrawalRate, retirementAge, retirementExpenses, retirementIncome, lifeExpectancy } = state.initialData;
            
            let effectiveNetWorth = netWorth;
            let fiAge = null;
            let zeroAge = null;

            const incomeIncreaseRate = annualIncomeIncrease / 100;
            const investmentRate = investmentReturnRate / 100;
            const inflationRateDec = inflationRate / 100;
            const swrDecimal = safeWithdrawalRate / 100;
            
            const fiNumber = retirementExpenses / swrDecimal;
            
            // Map life events by age for quick lookup
            const eventsByAge = state.lifeEvents.reduce((acc, event) => {
                if (!acc[event.startAge]) acc[event.startAge] = [];
                acc[event.startAge].push(event);
                return acc;
            }, {});

            for (let age = currentAge; age <= lifeExpectancy; age++) {
                const year = new Date().getFullYear() - currentAge + age;

                // Step 1: Calculate the base income and expenses for the current year
                let baseIncome;
                if (age < retirementAge) {
                    baseIncome = income * Math.pow(1 + incomeIncreaseRate, age - currentAge);
                } else {
                    baseIncome = retirementIncome * Math.pow(1 + inflationRateDec, age - retirementAge);
                }

                const baseExpenses = expenses * Math.pow(1 + inflationRateDec, age - currentAge);
                
                // Step 2: Apply life event changes to the base values for this year
                let effectiveIncome = baseIncome;
                let effectiveExpenses = baseExpenses;
                let effectiveTaxRate = taxFilingStatus === 'custom' ? customTaxRate / 100 : calculateTax(baseIncome, taxFilingStatus) / baseIncome;
                let oneTimeExpense = 0;

                const eventsForThisYear = eventsByAge[age] || [];

                eventsForThisYear.forEach(event => {
                    const eventDuration = (event.duration === null || event.duration === -1) ? (lifeExpectancy - event.startAge) : event.duration;
                    if (age >= event.startAge && age < event.startAge + eventDuration) {
                        if (event.changeType === 'income') {
                            if (event.operation === 'set') {
                                effectiveIncome = (event.valueType === 'percent') ? baseIncome * (event.value / 100) : event.value;
                            } else { // 'change'
                                effectiveIncome += (event.valueType === 'percent') ? baseIncome * (event.value / 100) : event.value;
                            }
                        } else if (event.changeType === 'expenses') {
                            if (event.operation === 'set') {
                                effectiveExpenses = (event.valueType === 'percent') ? (effectiveIncome - calculateTax(effectiveIncome, taxFilingStatus)) * (event.value / 100) : event.value;
                            } else { // 'change'
                                effectiveExpenses += (event.valueType === 'percent') ? (effectiveIncome - calculateTax(effectiveIncome, taxFilingStatus)) * (event.value / 100) : event.value;
                            }
                        } else if (event.changeType === 'taxRate') {
                            if (event.operation === 'set') {
                                effectiveTaxRate = event.value / 100;
                            } else {
                                effectiveTaxRate += event.value / 100;
                            }
                        } else if (event.changeType === 'oneTimeExpense') {
                            oneTimeExpense += event.value;
                        }
                    }
                });

                // Step 3: Recalculate taxes based on the potentially modified income
                const taxesPaid = (taxFilingStatus === 'custom') ? effectiveIncome * effectiveTaxRate : calculateTax(effectiveIncome, taxFilingStatus);
                
                // Step 4: Perform yearly financial calculations
                const netIncome = effectiveIncome - taxesPaid;
                const savings = netIncome - effectiveExpenses;
                const investmentGains = effectiveNetWorth * investmentRate;
                
                // Update net worth, including the one-time expense
                effectiveNetWorth = effectiveNetWorth + savings + investmentGains - oneTimeExpense;

                // Check for Financial Independence
                if (fiAge === null && effectiveNetWorth >= fiNumber && age < retirementAge) {
                    fiAge = age;
                }

                // Check for Net Worth hitting $0
                if (zeroAge === null && age >= retirementAge && effectiveNetWorth <= 0) {
                    zeroAge = age;
                }

                projection.push({
                    year,
                    age,
                    income: effectiveIncome,
                    expenses: effectiveExpenses,
                    taxes: taxesPaid,
                    taxRate: effectiveTaxRate,
                    savings,
                    oneTimeExpense,
                    netWorth: effectiveNetWorth
                });
            }

            state.projection = projection;
            state.fiAge = fiAge;
            state.zeroAge = zeroAge;
        };

        // --- UI RENDERING ---
        const showScreen = (screenId) => {
            document.querySelectorAll('.app-screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        };

        const renderInitialScreen = () => {
            const form = document.getElementById('initial-form');
            if (form) {
                // Pre-populate with defaults or saved state
                form.netWorth.value = state.initialData.netWorth;
                form.income.value = state.initialData.income;
                form.expenses.value = state.initialData.expenses;
                form.taxFilingStatus.value = state.initialData.taxFilingStatus;
                form.customTaxRate.value = state.initialData.customTaxRate;
                form.currentAge.value = state.initialData.currentAge;
                toggleInitialCustomTaxRateInput();
            }
        };
        
        const toggleInitialCustomTaxRateInput = () => {
            const status = document.getElementById('taxFilingStatus').value;
            const container = document.getElementById('customTaxRateContainer');
            if (status === 'custom') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        };

        const toggleEditCustomTaxRateInput = () => {
            const status = document.getElementById('editTaxFilingStatus').value;
            const container = document.getElementById('editCustomTaxRateContainer');
            if (status === 'custom') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        };


        const updateUI = () => {
            if (!state.isSetup) {
                showScreen('initial-screen');
                return;
            }

            calculateProjection();

            const dashboard = document.getElementById('main-dashboard');
            if (dashboard) {
                showScreen('main-dashboard');
                document.getElementById('current-net-worth').innerText = formatCurrency(state.initialData.netWorth);

                const projectedNetWorth = state.projection.find(p => p.age === state.initialData.retirementAge)?.netWorth || 0;
                document.getElementById('projected-net-worth').innerText = formatCurrency(projectedNetWorth);

                const savingsTarget = state.projection[0]?.savings || 0;
                document.getElementById('savings-target').innerText = formatCurrency(savingsTarget);

                // Update Net Worth Required to Retire
                const fiNumber = state.initialData.retirementExpenses / (state.initialData.safeWithdrawalRate / 100);
                document.getElementById('fi-number-display').innerText = formatCurrency(fiNumber);

                // Update Age of Financial Independence
                const fiAgeElement = document.getElementById('fi-age');
                const fiMessageElement = document.getElementById('fi-message');
                if (state.fiAge === null) {
                    fiAgeElement.innerText = "Not projected";
                    fiMessageElement.innerText = "You might not reach financial independence before your target retirement age.";
                    fiAgeElement.classList.add('text-rose-600');
                    fiAgeElement.classList.remove('text-teal-600');
                } else {
                    fiAgeElement.innerText = formatAge(state.fiAge);
                    fiMessageElement.innerText = "When passive income covers expenses.";
                    fiAgeElement.classList.remove('text-rose-600');
                    fiAgeElement.classList.add('text-teal-600');
                }

                // Update Net Worth Hits $0 section
                const zeroAgeElement = document.getElementById('zero-age');
                const zeroAgeMessageElement = document.getElementById('zero-age-message');

                if (state.zeroAge === null) {
                    zeroAgeElement.innerText = 'Beyond life expectancy';
                    zeroAgeMessageElement.innerText = 'Based on current projections, your funds will last beyond your life expectancy.';
                    zeroAgeElement.classList.add('text-green-500');
                    zeroAgeElement.classList.remove('text-rose-600');
                    zeroAgeMessageElement.classList.add('text-green-500');
                    zeroAgeMessageElement.classList.remove('text-rose-500');
                } else if (state.zeroAge < state.initialData.retirementAge) {
                    zeroAgeElement.innerText = formatAge(state.zeroAge);
                    zeroAgeMessageElement.innerText = 'You may run out of money before your target retirement age.';
                    zeroAgeElement.classList.remove('text-green-500');
                    zeroAgeElement.classList.add('text-rose-600');
                    zeroAgeMessageElement.classList.add('text-rose-500');
                    zeroAgeMessageElement.classList.remove('text-green-500');
                } else {
                    zeroAgeElement.innerText = formatAge(state.zeroAge);
                    zeroAgeMessageElement.innerText = 'Based on retirement spending.';
                    zeroAgeElement.classList.remove('text-green-500');
                    zeroAgeElement.classList.remove('text-rose-600');
                    zeroAgeMessageElement.classList.remove('text-rose-500');
                    zeroAgeMessageElement.classList.remove('text-green-500');
                }

                // Retirement message logic
                const retirementMessage = document.getElementById('retirement-message');
                if (projectedNetWorth < fiNumber) {
                    retirementMessage.innerText = 'You are not on track to retire at your goal age.';
                    retirementMessage.classList.remove('text-green-500');
                    retirementMessage.classList.add('text-rose-500');
                } else {
                    retirementMessage.innerText = 'You are on track to retire at your goal age!';
                    retirementMessage.classList.remove('text-rose-500');
                    retirementMessage.classList.add('text-green-500');
                }


                renderLifeEvents();
                renderProjectionTable();
                renderCharts();
                updateChartColors();
            }
        };

        const renderLifeEvents = () => {
            const list = document.getElementById('life-events-list');
            list.innerHTML = '';
            state.lifeEvents.forEach((event, index) => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-4 my-2 bg-white rounded-lg shadow';
                const changeText = getChangeDescription(event);

                const durationText = (event.duration === null || event.duration === -1) ? 'Lasts until death' : `${event.duration} years`;
                
                let timeFrameText = '';
                if(event.changeType === 'oneTimeExpense') {
                    timeFrameText = `Happens at age ${event.startAge}`;
                } else {
                    timeFrameText = `Starts at age ${event.startAge}, lasts ${durationText}.`;
                }

                li.innerHTML = `
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800">${event.name}</h4>
                        <p class="text-sm text-gray-600">
                            ${timeFrameText}
                            <br>
                            ${changeText}
                        </p>
                    </div>
                    <div>
                        <button class="edit-event-btn text-blue-500 hover:text-blue-700 font-semibold px-2" data-index="${index}" data-event-id="${event.id}">Edit</button>
                        ${event.isDeletable ? `<button class="delete-event-btn text-red-500 hover:text-red-700 font-semibold px-2" data-index="${index}">Delete</button>` : ''}
                    </div>
                `;
                list.appendChild(li);
            });
        };

        const getChangeDescription = (event) => {
            if (event.changeType === 'oneTimeExpense') {
                return `Deducts a one-time expense of ${formatCurrency(event.value)}.`;
            }
            const opText = event.operation === 'set' ? 'set to' : 'change by';
            const valueText = event.valueType === 'percent' ? `${event.value}%` : formatCurrency(event.value);
            let targetText = '';
            if (event.changeType === 'income') targetText = 'Income';
            else if (event.changeType === 'expenses') targetText = 'Expenses';
            else if (event.changeType === 'taxRate') targetText = 'Tax Rate';
            return `${targetText} ${opText} ${valueText}`;
        };

        const renderProjectionTable = () => {
            const tableBody = document.getElementById('projection-table-body');
            tableBody.innerHTML = '';
            const taxStatusMap = {
                single: 'Single',
                married: 'Married Filing Jointly',
                headOfHousehold: 'Head of Household',
                custom: 'Custom Rate'
            };

            const taxStatusDisplay = taxStatusMap[state.initialData.taxFilingStatus] || 'N/A';

            state.projection.forEach((yearData, index) => {
                let rowClass = 'border-b hover:bg-gray-50';
                if (index > 0 && yearData.netWorth < state.projection[index - 1].netWorth) {
                    rowClass += ' bg-red-100'; // Add light red background
                }
                
                // Find and display events for the current year
                const eventsForYear = state.lifeEvents
                    .filter(event => event.startAge === yearData.age)
                    .map(event => `<span class="event-link" data-event-id="${event.id}" data-event-name="${event.name}">${event.name}</span>`)
                    .join(', ');

                // Calculate expense percentage for expenses tooltip
                const afterTaxIncome = yearData.income - yearData.taxes;
                let expenseTooltipText = '';
                if (afterTaxIncome > 0) {
                    const expensePercentage = (yearData.expenses / afterTaxIncome) * 100;
                    expenseTooltipText = `${expensePercentage.toFixed(1)}% of after-tax income`;
                } else {
                    expenseTooltipText = "Expenses exceed after-tax income.";
                }

                // Calculate savings percentage for savings tooltip
                let savingsTooltipText = '';
                if (afterTaxIncome > 0) {
                    const savingsPercentage = (yearData.savings / afterTaxIncome) * 100;
                    savingsTooltipText = `${savingsPercentage.toFixed(1)}% of after-tax income`;
                } else {
                    savingsTooltipText = "No after-tax income to save from.";
                }

                // Calculate tax percentage for taxes tooltip
                const taxPercentage = yearData.income > 0 ? (yearData.taxes / yearData.income) * 100 : 0;
                const taxTooltipText = `Tax Status: ${taxStatusDisplay} - ${taxPercentage.toFixed(2)}% of income`;

                const row = document.createElement('tr');
                row.className = rowClass;
                row.innerHTML = `
                    <td class="px-6 py-3 text-sm font-bold text-gray-900">${yearData.age}</td>
                    <td class="px-6 py-3 text-sm font-medium text-gray-900">${yearData.year}</td>
                    <td class="px-6 py-3 text-sm text-gray-500">${formatCurrency(yearData.income)}</td>
                    <td class="px-6 py-3 text-sm text-gray-500 has-tooltip">
                        ${formatCurrency(yearData.taxes)}
                         <span class="tooltip-text">
                            ${taxTooltipText}
                        </span>
                    </td>
                    <td class="px-6 py-3 text-sm text-gray-500 has-tooltip">
                        ${formatCurrency(yearData.expenses)}
                        <span class="tooltip-text">
                            ${expenseTooltipText}
                        </span>
                    </td>
                    <td class="px-6 py-3 text-sm text-gray-500 has-tooltip">
                        ${formatCurrency(yearData.savings)}
                        <span class="tooltip-text">
                            ${savingsTooltipText}
                        </span>
                    </td>
                    <td class="px-6 py-3 text-sm text-gray-500">${eventsForYear}</td>
                    <td class="px-6 py-3 text-sm text-gray-500 font-bold">${formatCurrency(yearData.netWorth)}</td>
                `;
                tableBody.appendChild(row);
            });
        };

        let netWorthChart, yearlyFinancialsChart;

        const renderCharts = () => {
            const netWorthCtx = document.getElementById('netWorthChart').getContext('2d');
            const yearlyFinancialsCtx = document.getElementById('yearlyFinancialsChart').getContext('2d');

            const labels = state.projection.map(p => p.age);
            const netWorthData = state.projection.map(p => p.netWorth);
            const expensesData = state.projection.map(p => p.expenses);
            const taxesData = state.projection.map(p => p.taxes);
            const savingsData = state.projection.map(p => p.savings);

            if (netWorthChart) netWorthChart.destroy();
            if (yearlyFinancialsChart) yearlyFinancialsChart.destroy();

            const chartFontColor = darkModeState.enabled ? '#cbd5e0' : '#6B7280';
            const gridColor = darkModeState.enabled ? '#4a5568' : '#E2E8F0';

            netWorthChart = new Chart(netWorthCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Projected Net Worth',
                        data: netWorthData,
                        borderColor: darkModeState.enabled ? '#667eea' : '#4299E1',
                        backgroundColor: darkModeState.enabled ? 'rgba(102, 126, 234, 0.2)' : 'rgba(66, 153, 225, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            grid: { color: gridColor },
                            ticks: { color: chartFontColor }
                        }, 
                        x: { 
                            grid: { color: gridColor },
                            ticks: { color: chartFontColor }
                        } 
                    }
                }
            });

            yearlyFinancialsChart = new Chart(yearlyFinancialsCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Taxes',
                        data: taxesData,
                        backgroundColor: '#ECC94B'
                    }, {
                        label: 'Expenses',
                        data: expensesData,
                        backgroundColor: '#F56565'
                    }, {
                        label: 'Savings',
                        data: savingsData,
                        backgroundColor: '#48BB78'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            stacked: true, 
                            grid: { color: gridColor },
                            ticks: { color: chartFontColor }
                        },
                        y: { 
                            stacked: true, 
                            beginAtZero: true, 
                            grid: { color: gridColor },
                            ticks: { color: chartFontColor }
                        }
                    }
                }
            });
        };

        // --- MODALS & POPUPS ---
        const openModal = (modalId) => {
            document.getElementById(modalId).classList.remove('hidden');
        };

        const closeModal = (modalId) => {
            document.getElementById(modalId).classList.add('hidden');
        };

        const openLifeEventModal = (eventData = {}, eventIndex = null) => {
            const form = document.getElementById('life-event-form');
            form.reset();
            form.dataset.index = eventIndex !== null ? eventIndex : '';
            
            document.getElementById('life-event-title').innerText = eventIndex !== null ? 'Edit Life Event' : 'Add New Life Event';
            document.getElementById('life-event-submit-btn').innerText = eventIndex !== null ? 'Save Event' : 'Add Event';
            
            // Hide all change fields initially
            document.querySelectorAll('.change-field').forEach(field => field.classList.add('hidden'));
            document.getElementById('change-inputs-container').classList.add('hidden');

            // Hide duration for one-time expenses
            const durationField = document.querySelector('label[for="event-duration"]').parentNode;
            durationField.classList.remove('hidden');

            if (eventIndex !== null) {
                document.getElementById('event-name').value = eventData.name;
                document.getElementById('event-startAge').value = eventData.startAge;
                if (eventData.changeType !== 'oneTimeExpense') {
                    document.getElementById('event-duration').value = eventData.duration;
                    durationField.classList.remove('hidden');
                } else {
                    document.getElementById('event-duration').value = 1;
                    durationField.classList.add('hidden');
                }
                
                document.getElementById('event-change-type').value = eventData.changeType;

                document.getElementById('change-inputs-container').classList.remove('hidden');
                document.getElementById(`${eventData.changeType}-change-fields`).classList.remove('hidden');
                
                if (eventData.changeType === 'oneTimeExpense') {
                    document.getElementById('oneTimeExpense-value').value = eventData.value;
                } else {
                    document.getElementById(`${eventData.changeType}-op`).value = eventData.operation;
                    document.getElementById(`${eventData.changeType}-value`).value = eventData.value;
                    if (eventData.changeType !== 'taxRate') {
                        document.getElementById(`${eventData.changeType}-type`).value = eventData.valueType;
                    }
                }
            } else {
                 // Set default values for new events
                document.getElementById('event-duration').value = '';
                document.getElementById('income-op').value = 'set';
                document.getElementById('income-type').value = 'amount';
                document.getElementById('expenses-op').value = 'set';
                document.getElementById('expenses-type').value = 'amount';
                document.getElementById('taxRate-op').value = 'set';
            }

            openModal('life-event-modal');
        };
        
        const openAssumptionsModal = () => {
            const form = document.getElementById('assumptions-form');
            form.annualIncomeIncrease.value = state.initialData.annualIncomeIncrease;
            form.investmentReturnRate.value = state.initialData.investmentReturnRate;
            form.inflationRate.value = state.initialData.inflationRate;
            form.safeWithdrawalRate.value = state.initialData.safeWithdrawalRate;
            form.retirementAge.value = state.initialData.retirementAge;
            form.retirementExpenses.value = state.initialData.retirementExpenses;
            form.retirementIncome.value = state.initialData.retirementIncome;
            form.lifeExpectancy.value = state.initialData.lifeExpectancy;
            openModal('assumptions-modal');
        };

        const openRetirementAssumptionsModal = () => {
            const form = document.getElementById('retirement-assumptions-form');
            form.retirementSafeWithdrawalRate.value = state.initialData.safeWithdrawalRate;
            form.retirementRetirementAge.value = state.initialData.retirementAge;
            form.retirementRetirementExpenses.value = state.initialData.retirementExpenses;
            form.retirementRetirementIncome.value = state.initialData.retirementIncome;
            form.retirementLifeExpectancy.value = state.initialData.lifeExpectancy;
            openModal('retirement-assumptions-modal');
        };


        const openInitialDataModal = () => {
            document.getElementById('editNetWorth').value = state.initialData.netWorth;
            document.getElementById('editIncome').value = state.initialData.income;
            document.getElementById('editExpenses').value = state.initialData.expenses;
            document.getElementById('editTaxFilingStatus').value = state.initialData.taxFilingStatus;
            document.getElementById('editCustomTaxRate').value = state.initialData.customTaxRate;
            document.getElementById('editCurrentAge').value = state.initialData.currentAge;
            toggleEditCustomTaxRateInput();
            openModal('initial-data-modal');
        };

        // --- RETIREMENT EVENT LOGIC ---
        const createOrUpdateRetirementEvent = () => {
            let retirementEventIndex = state.lifeEvents.findIndex(e => e.id === 'retirement');
            const retirementEvent = {
                id: 'retirement',
                name: 'Retirement',
                startAge: state.initialData.retirementAge,
                duration: -1, // Lasts until end of projection
                changeType: 'expenses',
                operation: 'set',
                value: state.initialData.retirementExpenses,
                valueType: 'amount',
                isDeletable: false
            };

            if (retirementEventIndex > -1) {
                state.lifeEvents[retirementEventIndex] = retirementEvent;
            } else {
                state.lifeEvents.push(retirementEvent);
            }
        };

        // --- EVENT LISTENERS & INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadDarkMode();
            loadDataFromLocalStorage();
            renderInitialScreen();
            updateUI();
            
            // Dark Mode Toggles
            document.getElementById('initial-screen-dark-mode-toggle').addEventListener('click', toggleDarkMode);
            document.getElementById('dashboard-dark-mode-toggle').addEventListener('click', toggleDarkMode);

            // Shared handler for custom tax rate toggling
            function handleCustomTaxRateToggle(selectId, containerId) {
                const select = document.getElementById(selectId);
                const container = document.getElementById(containerId);
                select.addEventListener('change', () => {
                    container.classList.toggle('hidden', select.value !== 'custom');
                });
            }
            handleCustomTaxRateToggle('taxFilingStatus', 'customTaxRateContainer');
            handleCustomTaxRateToggle('editTaxFilingStatus', 'editCustomTaxRateContainer');

            // Form submissions
            document.getElementById('initial-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                state.initialData = {
                    ...state.initialData,
                    netWorth: parseFloat(form.netWorth.value),
                    income: parseFloat(form.income.value),
                    expenses: parseFloat(form.expenses.value),
                    taxFilingStatus: form.taxFilingStatus.value,
                    customTaxRate: parseFloat(form.customTaxRate.value) || DEFAULTS.customTaxRate,
                    currentAge: parseInt(form.currentAge.value, 10),
                };
                state.isSetup = true;
                createOrUpdateRetirementEvent();
                saveDataToLocalStorage();
            });
            document.getElementById('assumptions-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                state.initialData = {
                    ...state.initialData,
                    annualIncomeIncrease: parseFloat(form.annualIncomeIncrease.value),
                    investmentReturnRate: parseFloat(form.investmentReturnRate.value),
                    inflationRate: parseFloat(form.inflationRate.value),
                    safeWithdrawalRate: parseFloat(form.safeWithdrawalRate.value),
                    retirementAge: parseInt(form.retirementAge.value, 10),
                    retirementExpenses: parseFloat(form.retirementExpenses.value),
                    retirementIncome: parseFloat(form.retirementIncome.value),
                    lifeExpectancy: parseInt(form.lifeExpectancy.value, 10)
                };
                createOrUpdateRetirementEvent();
                saveDataToLocalStorage();
                closeModal('assumptions-modal');
            });
            document.getElementById('retirement-assumptions-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                state.initialData = {
                    ...state.initialData,
                    safeWithdrawalRate: parseFloat(form.retirementSafeWithdrawalRate.value),
                    retirementAge: parseInt(form.retirementRetirementAge.value, 10),
                    retirementExpenses: parseFloat(form.retirementRetirementExpenses.value),
                    retirementIncome: parseFloat(form.retirementRetirementIncome.value),
                    lifeExpectancy: parseInt(form.retirementLifeExpectancy.value, 10)
                };
                createOrUpdateRetirementEvent();
                saveDataToLocalStorage();
                closeModal('retirement-assumptions-modal');
            });
            document.getElementById('initial-data-form').addEventListener('submit', (e) => {
                e.preventDefault();
                state.initialData = {
                    ...state.initialData,
                    netWorth: parseFloat(document.getElementById('editNetWorth').value),
                    income: parseFloat(document.getElementById('editIncome').value),
                    expenses: parseFloat(document.getElementById('editExpenses').value),
                    taxFilingStatus: document.getElementById('editTaxFilingStatus').value,
                    customTaxRate: parseFloat(document.getElementById('editCustomTaxRate').value) || DEFAULTS.customTaxRate,
                    currentAge: parseInt(document.getElementById('editCurrentAge').value, 10),
                };
                createOrUpdateRetirementEvent();
                saveDataToLocalStorage();
                closeModal('initial-data-modal');
            });

            document.getElementById('life-event-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                const index = form.dataset.index;
                const changeType = form.changeType.value;
                let newEvent = {
                    name: form.name.value,
                    startAge: parseInt(form.startAge.value, 10),
                    changeType: changeType,
                    isDeletable: true
                };
                if (changeType === 'oneTimeExpense') {
                    newEvent.duration = 1;
                    newEvent.value = parseFloat(form.querySelector(`#oneTimeExpense-value`).value);
                } else {
                    newEvent.duration = form.duration.value ? parseInt(form.duration.value, 10) : null;
                    newEvent.operation = form.querySelector(`#${changeType}-op`).value;
                    newEvent.value = parseFloat(form.querySelector(`#${changeType}-value`).value);
                    newEvent.valueType = changeType !== 'taxRate' ? form.querySelector(`#${changeType}-type`).value : 'percent';
                }
                if (index) {
                    state.lifeEvents[index] = newEvent;
                } else {
                    state.lifeEvents.push(newEvent);
                }
                saveDataToLocalStorage();
                closeModal('life-event-modal');
            });

            // Event delegation for edit buttons that open retirement assumptions modal
            document.querySelectorAll('.open-retirement-assumptions-btn').forEach(btn => {
                btn.addEventListener('click', openRetirementAssumptionsModal);
            });
            // Initial Data edit button
            document.getElementById('edit-initial-data-btn').addEventListener('click', openInitialDataModal);
            document.getElementById('edit-current-net-worth-btn').addEventListener('click', openInitialDataModal);
            // Add event buttons
            document.getElementById('add-life-event-btn').addEventListener('click', openLifeEventModal);
            // Edit assumptions button
            document.getElementById('edit-assumptions-btn').addEventListener('click', openAssumptionsModal);
            // Restart session
            document.getElementById('restart-session-btn').addEventListener('click', () => {
                localStorage.removeItem('financialProjectionState');
                Object.assign(state, {
                    initialData: { ...DEFAULTS },
                    lifeEvents: [],
                    isSetup: false,
                    projection: [],
                    fiAge: null,
                    zeroAge: null
                });
                createOrUpdateRetirementEvent();
                updateUI();
            });
            // Close modal buttons
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modalId = e.target.closest('.modal-overlay').id;
                    closeModal(modalId);
                });
            });
            // Dynamic display of financial change inputs
            document.getElementById('event-change-type').addEventListener('change', (e) => {
                const changeType = e.target.value;
                document.querySelectorAll('.change-field').forEach(field => field.classList.add('hidden'));
                const durationField = document.querySelector('label[for="event-duration"]').parentNode;
                durationField.classList.toggle('hidden', changeType === 'oneTimeExpense');
                if (changeType) {
                    document.getElementById('change-inputs-container').classList.remove('hidden');
                    document.getElementById(`${changeType}-change-fields`).classList.remove('hidden');
                } else {
                    document.getElementById('change-inputs-container').classList.add('hidden');
                }
            });

            // Dashboard edit buttons event listeners
            // Projected Net Worth at Retirement
            if (document.getElementById('edit-retirement-assumptions-btn')) {
                document.getElementById('edit-retirement-assumptions-btn').addEventListener('click', openRetirementAssumptionsModal);
            }
            // Net Worth Required to Retire
            if (document.getElementById('edit-fi-assumptions-btn')) {
                document.getElementById('edit-fi-assumptions-btn').addEventListener('click', openRetirementAssumptionsModal);
            }
            // Age of Financial Independence
            if (document.getElementById('edit-fi-age-assumptions-btn')) {
                document.getElementById('edit-fi-age-assumptions-btn').addEventListener('click', openRetirementAssumptionsModal);
            }
            // Net Worth Hits $0
            if (document.getElementById('edit-lifespan-assumptions-btn')) {
                document.getElementById('edit-lifespan-assumptions-btn').addEventListener('click', openRetirementAssumptionsModal);
            }

            // Life event edit button event delegation
            const lifeEventsList = document.getElementById('life-events-list');
            if (lifeEventsList) {
                lifeEventsList.addEventListener('click', function(e) {
                    const editBtn = e.target.closest('.edit-event-btn');
                    if (editBtn) {
                        const index = editBtn.getAttribute('data-index');
                        const eventData = state.lifeEvents[index];
                        openLifeEventModal(eventData, index);
                    }
                });
            }

            // Initial creation of the retirement event when the page loads
            createOrUpdateRetirementEvent();
        });
    </script>
</body>
</html>
